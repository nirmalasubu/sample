version: '2.1'

services:
  odt-api:
    env_file:
      - ./env/shared.env
      - ./env/api.env
    build: 
      context: ../
      dockerfile: Dockerfile.api
    image: quay.io/turner/odt-api:${VERSION}.${CIRCLE_BUILD_NUM}
    ports:
      - "5000:5000"
    environment:
      ASPNETCORE_ENVIRONMENT: development
      HEALTHCHECK: /healthcheck
      PORT: "5000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/healthcheck"]
      interval: 10s
      timeout: 10s
      retries: 2
    
  odt-webapp:
    env_file:
      - ./env/shared.env
      - ./env/portal.env
    build:
      context: ../
      dockerfile: Dockerfile.portal
    image: quay.io/turner/odt-portal:${VERSION}.${CIRCLE_BUILD_NUM}
    ports:
      - "5001:5000"
    environment:
      ASPNETCORE_ENVIRONMENT: development
      HEALTHCHECK: /healthcheck
      PORT: "5000"

  odt-jobs:
    env_file:
      - ./env/shared.env
      - ./env/jobs.env
    build:
      context: ../
      dockerfile: Dockerfile.jobs
    image: quay.io/turner/odt-jobs:${VERSION}.${CIRCLE_BUILD_NUM}
    ports:
      - "5002:5000"
    environment:
      ASPNETCORE_ENVIRONMENT: development
      HEALTHCHECK: /healthcheck
      PORT: "5000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/healthcheck"]
      interval: 1m30s
      timeout: 10s
      retries: 2

  odt-jobs-tests:
    env_file:
      - ./env/shared.env
      - ./env/jobs.env
    build:
      context: ../
      dockerfile: Dockerfile.jobs.tests      
    stdin_open: true
    tty: true  
    depends_on:
      odt-api:
        condition: service_healthy
      odt-jobs:
        condition: service_healthy
    links:
      - odt-api:apihost
      - odt-jobs:jobhost

  odt-api-tests:
    stdin_open: true
    tty: true    
    env_file:
      - ./env/shared.env
      - ./env/jobs.env
    build:
      context: ../
      dockerfile: Dockerfile.api.tests      
    depends_on:
      odt-api:
        condition: service_healthy
    links:
      - odt-api:apihost   
  
  quick-test:
    stdin_open: true
    tty: true
    env_file:
      - ./env/shared.env
      - ./env/jobs.env
    build:
      context: ../
      dockerfile: Dockerfile.quick.test
    