general:
  branches:
    only:
     - dev
     - rc     
      
machine:
  pre:  
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.9.0 

  services:
    - docker


dependencies:
  override:
       
    # use harbor-deploy to get image tag (version) from package.json (or TURNER_METADATA)
    - docker login -e="." -u="${DOCKER_USER}" -p="${DOCKER_PASS}" quay.io

    # create CI environment for API
    - docker run -v $(pwd):/data quay.io/turner/harbor-deploy set_build_values \
          -s "${API_SHIPMENT_NAME}" \
          -t "${API_SHIPMENT_BUILD_TOKEN_DEV}" \
          -e "dev" \          
          -b "${CIRCLE_BRANCH}" \
          -n "${CIRCLE_BUILD_NUM}" > api-dev;
    - cat api-dev             
    - sudo sed -i 's/odt/odt-api/' api-dev;
    - cat api-dev
    - docker run -v $(pwd):/data quay.io/turner/harbor-deploy set_build_values \
          -s "${API_SHIPMENT_NAME}" \
          -t "${API_SHIPMENT_BUILD_TOKEN_QA}" \
          -e "qa" \          
          -b "${CIRCLE_BRANCH}" \
          -n "${CIRCLE_BUILD_NUM}" > api-rc;
    - cat api-qa
    - sudo sed -i 's/odt/odt-api/' api-rc;
    - cat api-rc

#    - docker run -v $(pwd):/data quay.io/turner/harbor-deploy set_build_values \
#          -s "${SHIPMENT_NAME}" \
#          -t "${SHIPMENT_BUILD_TOKEN_QA}" \ 
#          -e "qa" \
#          -b "${CIRCLE_BRANCH}" \
#          -n "${CIRCLE_BUILD_NUM}" > rc;
#
    # change shipment, image name, container name
    # create enivironment for api development
    


test:
  override:
    # Build image for API project and test
    - cat api-dev
    - cat api-rc
#    - source "${CIRCLE_BRANCH}"; sudo docker build --rm=false -t "quay.io/turner/odt-api:${VERSION}" -f OnDemandTools.API/Dockerfile .
#    - source "${CIRCLE_BRANCH}"; sudo docker run -d --name odt-api-container -p 5000:5000 "quay.io/turner/odt-api:${VERSION}"; sleep 10  
#    - sudo curl --retry 10 --retry-delay 5 -v http://0.0.0.0:5000/healthcheck
#    - sudo curl --retry 10 --retry-delay 5 -v http://localhost:5000/healthcheck
#    - sudo docker stop odt-api-container
#  
#
#    #Build image for Deporter project and test
#    - source "${CIRCLE_BRANCH}"; sudo docker build --rm=false -t "quay.io/turner/odt-job-deporter:${VERSION}" -f OnDemandTools.Deporter/Dockerfile .
#    - source "${CIRCLE_BRANCH}"; sudo docker run -d --name odt-job-container -p 5000:5000 "quay.io/turner/odt-job-deporter:${VERSION}"; sleep 10
#    - sudo curl --retry 10 --retry-delay 5 -v http://0.0.0.0:5000/healthcheck
#    - sudo curl --retry 10 --retry-delay 5 -v http://localhost:5000/healthcheck
#    - sudo docker stop odt-job-container


deployment:
  development:
    branch: dev
    commands:    
      # Deploy API
      - cat api-dev
      - cat api-rc 
#      - source dev; sudo docker push "${IMAGE}"
#      - source dev; sudo docker run -it --env-file dev quay.io/turner/harbor-deploy deploy --verbose=true --catalog=true
#
#      # Deploy deporter job      
#      - sudo sed -i 's/odt-api/odt-job-deporter/' dev     
#      - source dev; sudo docker push "${IMAGE}"
#      - source dev; sudo docker run -it --env-file dev quay.io/turner/harbor-deploy deploy --verbose=true --catalog=true
#
#  release:
#    branch: rc
#    commands:
#      - source rc; sudo docker push "${IMAGE}"
#      - source rc; sudo docker run -it --env-file rc quay.io/turner/harbor-deploy deploy --verbose=true --catalog=true
#
#