general:
  branches:
    only:
      - dev 
	  - rc
	  - /feature-.*/
      
machine:
  pre:  
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.9.0 

  services:
    - docker


dependencies:
  override:
       
    # use harbor-deploy to get image tag (version) from package.json (or TURNER_METADATA)
    - docker login -e="." -u="${DOCKER_USER}" -p="${DOCKER_PASS}" quay.io
    - docker run -v $(pwd):/data quay.io/turner/harbor-deploy set_build_values \
          -s "${SHIPMENT_NAME}" \
          -t "${SHIPMENT_BUILD_TOKEN_DEV}" \
          -e "dev" \          
          -b "${CIRCLE_BRANCH}" \
          -n "${CIRCLE_BUILD_NUM}" > dev;

    #- docker run -v $(pwd):/data quay.io/turner/harbor-deploy set_build_values \
    #      -s "${SHIPMENT_NAME}" \
    #      -e "qa" \
    #      -t "${SHIPMENT_BUILD_TOKEN_QA}" \
    #      -b "${CIRCLE_BRANCH}" \
    #      -n "${CIRCLE_BUILD_NUM}" > qa;
          
    - cat dev
    #- cat qa

test:
  override:
    - source dev; sudo docker build --rm=false -t "${IMAGE}" -f OnDemandTools.API/Dockerfile .

    #- sudo docker images
    #- sudo docker ps -a
    - source dev; sudo docker run -d --name odtapicontainer -p 5000:5000 "${IMAGE}"; sleep 10
    #- sudo docker ps -a
    - sudo curl --retry 10 --retry-delay 5 -v http://0.0.0.0:5000/healthcheck
    - sudo curl --retry 10 --retry-delay 5 -v http://localhost:5000/healthcheck


deployment:
  CD:
    branch: dev
    commands:
    
      - source dev; sudo docker push "${IMAGE}"
      - source dev; sudo docker run -it --env-file dev quay.io/turner/harbor-deploy deploy --verbose=true --catalog=true    

	#branch: rc
    #commands:
    
    #  - source qa; sudo docker push "${IMAGE}"
    #  - source qa; sudo docker run -it --env-file dev quay.io/turner/harbor-deploy deploy --verbose=true --catalog=true   